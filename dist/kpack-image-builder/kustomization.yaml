apiVersion: kustomize.config.k8s.io/v1beta1
kind: Kustomization

namespace: korifi-kpack-build-system

namePrefix: korifi-kpack-build-

resources:
- ../config
- ../../kpack-image-builder/config/default
- cluster_builder.yaml
- cluster_stack.yaml
- cluster_store.yaml
- service_account.yaml

replacements:
- source:
    fieldPath: data.rootNamespace
    kind: ConfigMap
    name: config
    version: v1
  targets:
  - fieldPaths:
    - spec.template.spec.containers.[name=manager].env.[name=ROOT_NAMESPACE].value
    select:
      kind: Deployment
      name: controller-manager
      version: v1
  - fieldPaths:
    - spec.serviceAccountRef.namespace
    select:
      group: kpack.io
      kind: ClusterBuilder
      name: cf-kpack-cluster-builder
      version: v1alpha2
  - fieldPaths:
    - metadata.namespace
    select:
      kind: ServiceAccount
      name: kpack-service-account
      version: v1
- source:
    fieldPath: metadata.name
    kind: ServiceAccount
    name: kpack-service-account
    version: v1
  targets:
  - fieldPaths:
    - spec.serviceAccountRef.name
    select:
      group: kpack.io
      kind: ClusterBuilder
      name: cf-kpack-cluster-builder
      version: v1alpha2
- source:
    fieldPath: metadata.name
    group: kpack.io
    kind: ClusterStack
    name: cf-default-stack
    version: v1alpha2
  targets:
  - fieldPaths:
    - spec.stack.name
    select:
      group: kpack.io
      kind: ClusterBuilder
      name: cf-kpack-cluster-builder
      version: v1alpha2
- source:
    fieldPath: metadata.name
    group: kpack.io
    kind: ClusterStore
    name: cf-default-buildpacks
    version: v1alpha2
  targets:
  - fieldPaths:
    - spec.store.name
    select:
      group: kpack.io
      kind: ClusterBuilder
      name: cf-kpack-cluster-builder
      version: v1alpha2
- source:
    fieldPath: data.clusterBuilderName
    kind: ConfigMap
    name: config
    version: v1
  targets:
  - fieldPaths:
    - spec.template.spec.containers.[name=manager].env.[name=CLUSTER_BUILDER_NAME].value
    select:
      kind: Deployment
      name: controller-manager
      version: v1
- source:
    fieldPath: data.kpackImageTag
    kind: ConfigMap
    name: config
    version: v1
  targets:
  - fieldPaths:
    - spec.template.spec.containers.[name=manager].env.[name=KPACK_IMAGE_TAG].value
    select:
      kind: Deployment
      name: controller-manager
      version: v1
  - fieldPaths:
    - spec.tag
    select:
      group: kpack.io
      kind: ClusterBuilder
      name: cf-kpack-cluster-builder
      version: v1alpha2
images:
- name: cloudfoundry/korifi-kpack-image-builder
  newName: cloudfoundry/korifi-kpack-image-builder
  newTag: latest
